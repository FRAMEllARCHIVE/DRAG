<html><head><base href="." />
<title>P2P File Sharing</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: #f0f2f5;
    }

    .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .peer-info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
    }

    .connection-section {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
    }

    button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        transition: background 0.3s;
    }

    button:hover {
        background: #1976d2;
    }

    #fileInput {
        margin: 10px 0;
    }

    .progress {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-bar {
        width: 0%;
        height: 100%;
        background: #4caf50;
        transition: width 0.3s;
    }

    .status {
        color: #666;
        margin: 10px 0;
    }

    .copy-btn {
        background: #4caf50;
    }

    #receivedFiles {
        margin-top: 20px;
    }

    .file-item {
        background: #f8f9fa;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>P2P File Sharing</h1>
        
        <div class="peer-info">
            <h3>Your Peer ID:</h3>
            <div id="pid"></div>
            <button class="copy-btn" onclick="copyPeerID()">Copy ID</button>
        </div>

        <div class="connection-section">
            <h3>Connect to Peer</h3>
            <input type="text" id="connectionInput" placeholder="Enter peer ID">
            <button onclick="connectToPeer()">Connect</button>
        </div>

        <div id="connectionStatus" class="status"></div>

        <div id="fileSharing" style="display: none;">
            <h3>Share Files</h3>
            <input type="file" id="fileInput" multiple>
            <button onclick="sendFiles()">Send Files</button>
            
            <div class="progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="transferStatus" class="status"></div>
        </div>

        <div id="receivedFiles">
            <h3>Received Files</h3>
        </div>
    </div>

<script>
let peer = null;
let conn = null;
const CHUNK_SIZE = 16384; // 16KB chunks

// Initialize peer connection
function initPeer() {
    peer = new Peer();
    
    peer.on('open', (id) => {
        document.getElementById('pid').textContent = id;
    });

    peer.on('connection', (connection) => {
        conn = connection;
        setupConnection();
    });

    peer.on('error', (err) => {
        console.error(err);
        document.getElementById('connectionStatus').textContent = `Error: ${err.message}`;
    });
}

function connectToPeer() {
    const peerId = document.getElementById('connectionInput').value;
    if (!peerId) {
        alert('Please enter a peer ID');
        return;
    }

    conn = peer.connect(peerId);
    setupConnection();
}

function setupConnection() {
    conn.on('open', () => {
        document.getElementById('connectionStatus').textContent = 'Connected!';
        document.getElementById('fileSharing').style.display = 'block';
        
        conn.on('data', handleReceivedData);
    });

    conn.on('error', (err) => {
        console.error(err);
        document.getElementById('connectionStatus').textContent = `Connection error: ${err.message}`;
    });
}

let fileQueue = [];
let currentFileTransfer = null;

async function sendFiles() {
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    
    if (files.length === 0) return;

    for (let file of files) {
        fileQueue.push(file);
    }

    if (!currentFileTransfer) {
        processFileQueue();
    }
}

async function processFileQueue() {
    if (fileQueue.length === 0) {
        currentFileTransfer = null;
        return;
    }

    const file = fileQueue.shift();
    currentFileTransfer = {
        name: file.name,
        size: file.size,
        type: file.type
    };

    // Send file metadata first
    conn.send({
        type: 'file-meta',
        file: currentFileTransfer
    });

    const chunkCount = Math.ceil(file.size / CHUNK_SIZE);
    const reader = new FileReader();
    let offset = 0;

    reader.onload = (e) => {
        conn.send({
            type: 'file-chunk',
            data: e.target.result,
            offset: offset
        });

        offset += e.target.result.byteLength;
        const progress = (offset / file.size) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
        document.getElementById('transferStatus').textContent = 
            `Sending ${file.name}: ${Math.round(progress)}%`;

        if (offset < file.size) {
            readNextChunk();
        } else {
            if (fileQueue.length > 0) {
                processFileQueue();
            } else {
                currentFileTransfer = null;
                document.getElementById('transferStatus').textContent = 'Transfer complete!';
            }
        }
    };

    function readNextChunk() {
        const slice = file.slice(offset, offset + CHUNK_SIZE);
        reader.readAsArrayBuffer(slice);
    }

    readNextChunk();
}

let receivingFile = null;
let receivedChunks = [];

function handleReceivedData(data) {
    if (data.type === 'file-meta') {
        receivingFile = data.file;
        receivedChunks = [];
        document.getElementById('transferStatus').textContent = 
            `Receiving ${receivingFile.name}...`;
    }
    else if (data.type === 'file-chunk') {
        receivedChunks.push(data.data);
        const received = receivedChunks.reduce((acc, chunk) => acc + chunk.byteLength, 0);
        const progress = (received / receivingFile.size) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
        
        if (received >= receivingFile.size) {
            const blob = new Blob(receivedChunks, { type: receivingFile.type });
            displayReceivedFile(blob, receivingFile.name);
            receivingFile = null;
            receivedChunks = [];
        }
    }
}

function displayReceivedFile(blob, fileName) {
    const url = URL.createObjectURL(blob);
    const div = document.createElement('div');
    div.className = 'file-item';
    
    const nameSpan = document.createElement('span');
    nameSpan.textContent = fileName;
    
    const downloadBtn = document.createElement('a');
    downloadBtn.href = url;
    downloadBtn.download = fileName;
    downloadBtn.textContent = 'Download';
    downloadBtn.className = 'button';
    
    div.appendChild(nameSpan);
    div.appendChild(downloadBtn);
    
    document.getElementById('receivedFiles').appendChild(div);
}

function copyPeerID() {
    const pid = document.getElementById('pid').textContent;
    navigator.clipboard.writeText(pid).then(() => {
        alert('Peer ID copied to clipboard!');
    });
}

// Initialize when page loads
window.onload = initPeer;
</script>
</body></html>